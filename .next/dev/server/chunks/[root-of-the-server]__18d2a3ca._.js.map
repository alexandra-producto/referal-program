{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/usuario/Referal%20MVP/src/utils/linkedinAuth.ts"],"sourcesContent":["// Funciones helper para obtener variables de entorno (lazy loading)\n// Next.js carga .env.local automáticamente, pero verificamos que estén disponibles\nfunction getLinkedInClientId(): string {\n  const value = process.env.LINKEDIN_CLIENT_ID;\n  if (!value) {\n    console.error(\"❌ LINKEDIN_CLIENT_ID no encontrado en process.env\");\n    console.error(\"Variables disponibles:\", Object.keys(process.env).filter(k => k.includes(\"LINKEDIN\")));\n    throw new Error(\"LINKEDIN_CLIENT_ID no está configurado. Verifica que esté en .env.local\");\n  }\n  return value;\n}\n\nfunction getLinkedInClientSecret(): string {\n  const value = process.env.LINKEDIN_CLIENT_SECRET;\n  if (!value) {\n    console.error(\"❌ LINKEDIN_CLIENT_SECRET no encontrado en process.env\");\n    throw new Error(\"LINKEDIN_CLIENT_SECRET no está configurado. Verifica que esté en .env.local\");\n  }\n  return value;\n}\n\nfunction getLinkedInRedirectUri(): string {\n  const value = process.env.LINKEDIN_REDIRECT_URI;\n  if (!value) {\n    console.error(\"❌ LINKEDIN_REDIRECT_URI no encontrado en process.env\");\n    throw new Error(\"LINKEDIN_REDIRECT_URI no está configurado. Verifica que esté en .env.local\");\n  }\n  return value;\n}\n\nexport interface LinkedInUserInfo {\n  sub: string; // LinkedIn ID\n  email?: string;\n  name?: string;\n  given_name?: string;\n  family_name?: string;\n  picture?: string;\n}\n\nexport interface LinkedInProfile {\n  id: string;\n  vanityName?: string;\n  localizedFirstName?: string;\n  localizedLastName?: string;\n  headline?: string;\n}\n\n/**\n * Genera la URL de autorización de LinkedIn\n */\nexport function getLinkedInAuthUrl(state: string, role: string): string {\n  const clientId = getLinkedInClientId();\n  const redirectUri = getLinkedInRedirectUri();\n\n  const params = new URLSearchParams({\n    response_type: \"code\",\n    client_id: clientId,\n    redirect_uri: redirectUri,\n    scope: \"openid profile email\",\n    state: state,\n  });\n\n  return `https://www.linkedin.com/oauth/v2/authorization?${params.toString()}`;\n}\n\n/**\n * Intercambia el código de autorización por un access token\n */\nexport async function exchangeCodeForToken(code: string): Promise<string> {\n  const clientId = getLinkedInClientId();\n  const clientSecret = getLinkedInClientSecret();\n  const redirectUri = getLinkedInRedirectUri();\n\n  const response = await fetch(\"https://www.linkedin.com/oauth/v2/accessToken\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n    },\n    body: new URLSearchParams({\n      grant_type: \"authorization_code\",\n      code: code,\n      redirect_uri: redirectUri,\n      client_id: clientId,\n      client_secret: clientSecret,\n    }),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(`Error obteniendo token: ${response.status} - ${errorText}`);\n  }\n\n  const data = await response.json();\n  return data.access_token;\n}\n\n/**\n * Obtiene información del usuario desde LinkedIn usando OpenID Connect\n */\nexport async function getUserInfo(accessToken: string): Promise<LinkedInUserInfo> {\n  const response = await fetch(\"https://api.linkedin.com/v2/userinfo\", {\n    headers: {\n      Authorization: `Bearer ${accessToken}`,\n    },\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(`Error obteniendo userinfo: ${response.status} - ${errorText}`);\n  }\n\n  return await response.json();\n}\n\n/**\n * Obtiene perfil adicional del usuario (headline, vanityName)\n */\nexport async function getProfile(accessToken: string): Promise<LinkedInProfile | null> {\n  try {\n    const response = await fetch(\n      \"https://api.linkedin.com/v2/me?projection=(id,vanityName,localizedFirstName,localizedLastName,headline)\",\n      {\n        headers: {\n          Authorization: `Bearer ${accessToken}`,\n        },\n      }\n    );\n\n    if (!response.ok) {\n      // Si falla, no es crítico, retornamos null\n      return null;\n    }\n\n    return await response.json();\n  } catch (error) {\n    console.warn(\"Error obteniendo perfil adicional de LinkedIn:\", error);\n    return null;\n  }\n}\n\n/**\n * Parsea el headline de LinkedIn para extraer current_role y current_company\n */\nexport function parseHeadline(headline?: string): {\n  current_role: string | null;\n  current_company: string | null;\n} {\n  if (!headline) {\n    return { current_role: null, current_company: null };\n  }\n\n  // Buscar patrón \"Role at Company\"\n  const atMatch = headline.match(/^(.+?)\\s+at\\s+(.+)$/i);\n  if (atMatch) {\n    return {\n      current_role: atMatch[1].trim(),\n      current_company: atMatch[2].trim(),\n    };\n  }\n\n  return { current_role: null, current_company: null };\n}\n\n/**\n * Construye la URL de LinkedIn del usuario\n */\nexport function buildLinkedInUrl(vanityName?: string): string | null {\n  if (!vanityName) {\n    return null;\n  }\n  return `https://www.linkedin.com/in/${vanityName}`;\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 182, "column": 0}, "map": {"version":3,"sources":["file:///Users/usuario/Referal%20MVP/app/api/auth/linkedin/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { SignJWT } from \"jose\";\nimport { cookies } from \"next/headers\";\nimport { getLinkedInAuthUrl } from \"../../../../src/utils/linkedinAuth\";\n\n// Next.js carga .env.local automáticamente en rutas API\n// Las variables deberían estar disponibles en process.env\n\nconst SECRET_KEY = process.env.SESSION_SECRET || process.env.RECOMMENDATION_SECRET || \"fallback-secret-key\";\nconst secret = new TextEncoder().encode(SECRET_KEY);\n\n/**\n * GET /api/auth/linkedin\n * Inicia el flujo de OAuth con LinkedIn\n * Query params: role (admin | hyperconnector | solicitante)\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams;\n    const role = searchParams.get(\"role\");\n\n    if (!role || ![\"admin\", \"hyperconnector\", \"solicitante\"].includes(role)) {\n      return NextResponse.json(\n        { error: \"Rol inválido. Debe ser: admin, hyperconnector o solicitante\" },\n        { status: 400 }\n      );\n    }\n\n    // Generar state anti-CSRF\n    const state = await new SignJWT({ role, timestamp: Date.now() })\n      .setProtectedHeader({ alg: \"HS256\" })\n      .setExpirationTime(\"10m\") // 10 minutos\n      .sign(secret);\n\n    // Guardar state en cookie firmada\n    const cookieStore = await cookies();\n    cookieStore.set(\"oauth_state\", state, {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === \"production\",\n      sameSite: \"lax\",\n      maxAge: 600, // 10 minutos\n      path: \"/\",\n    });\n\n    // Redirigir a LinkedIn\n    const authUrl = getLinkedInAuthUrl(state, role);\n\n    return NextResponse.redirect(authUrl);\n  } catch (error: any) {\n    console.error(\"Error en /api/auth/linkedin:\", error);\n    return NextResponse.json(\n      { error: \"Error al iniciar autenticación con LinkedIn\" },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEA,wDAAwD;AACxD,0DAA0D;AAE1D,MAAM,aAAa,QAAQ,GAAG,CAAC,cAAc,IAAI,QAAQ,GAAG,CAAC,qBAAqB,IAAI;AACtF,MAAM,SAAS,IAAI,cAAc,MAAM,CAAC;AAOjC,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,eAAe,QAAQ,OAAO,CAAC,YAAY;QACjD,MAAM,OAAO,aAAa,GAAG,CAAC;QAE9B,IAAI,CAAC,QAAQ,CAAC;YAAC;YAAS;YAAkB;SAAc,CAAC,QAAQ,CAAC,OAAO;YACvE,OAAO,gKAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA8D,GACvE;gBAAE,QAAQ;YAAI;QAElB;QAEA,0BAA0B;QAC1B,MAAM,QAAQ,MAAM,IAAI,kLAAO,CAAC;YAAE;YAAM,WAAW,KAAK,GAAG;QAAG,GAC3D,kBAAkB,CAAC;YAAE,KAAK;QAAQ,GAClC,iBAAiB,CAAC,OAAO,aAAa;SACtC,IAAI,CAAC;QAER,kCAAkC;QAClC,MAAM,cAAc,MAAM,IAAA,4JAAO;QACjC,YAAY,GAAG,CAAC,eAAe,OAAO;YACpC,UAAU;YACV,QAAQ,oDAAyB;YACjC,UAAU;YACV,QAAQ;YACR,MAAM;QACR;QAEA,uBAAuB;QACvB,MAAM,UAAU,IAAA,oKAAkB,EAAC,OAAO;QAE1C,OAAO,gKAAY,CAAC,QAAQ,CAAC;IAC/B,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,gKAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA8C,GACvD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}