{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/usuario/Referal%20MVP/app/api/jobs/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { validateCreateJobRequest } from '../../../../src/types/jobCreation';\nimport { createJobFromCandidate } from '../../../../src/services/jobCreationService';\n\n/**\n * GET /api/jobs\n * Obtiene los jobs filtrados por owner_candidate_id (opcional)\n * \n * Query params:\n * - owner_candidate_id: UUID del candidate que creó los jobs\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const ownerCandidateId = searchParams.get('owner_candidate_id');\n\n    const { supabase } = await import('../../../../src/db/supabaseClient');\n\n    let query = supabase.from('jobs').select('*');\n\n    if (ownerCandidateId) {\n      query = query.eq('owner_candidate_id', ownerCandidateId);\n    }\n\n    // Ordenar por fecha de creación (más recientes primero)\n    query = query.order('created_at', { ascending: false });\n\n    const { data: jobs, error } = await query;\n\n    if (error) {\n      console.error('❌ Error fetching jobs:', error);\n      return NextResponse.json(\n        { error: 'Error fetching jobs', details: error.message },\n        { status: 500 }\n      );\n    }\n\n    // Para cada job, obtener el conteo de recomendaciones\n    if (jobs && jobs.length > 0) {\n      const jobIds = jobs.map((j: any) => j.id);\n      \n      const { data: recommendations } = await supabase\n        .from('recommendations')\n        .select('job_id')\n        .in('job_id', jobIds);\n\n      // Contar recomendaciones por job\n      const recommendationCounts = new Map<string, number>();\n      if (recommendations) {\n        recommendations.forEach((r: any) => {\n          const count = recommendationCounts.get(r.job_id) || 0;\n          recommendationCounts.set(r.job_id, count + 1);\n        });\n      }\n\n      // Agregar conteo a cada job\n      const jobsWithCounts = jobs.map((job: any) => ({\n        ...job,\n        recommendations_count: recommendationCounts.get(job.id) || 0,\n      }));\n\n      return NextResponse.json({ jobs: jobsWithCounts });\n    }\n\n    return NextResponse.json({ jobs: [] });\n  } catch (error: any) {\n    console.error('❌ Error in GET /api/jobs:', error);\n    return NextResponse.json(\n      {\n        error: 'Error fetching jobs',\n        details: process.env.NODE_ENV === 'development' ? error.message : undefined,\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST /api/jobs\n * Crea un nuevo job desde la UI de \"Crear solicitud de rol\"\n * \n * Body esperado:\n * {\n *   jobTitle: string,\n *   description: string,\n *   nonNegotiables: string,\n *   desiredTrajectory: string,\n *   scenario: string,\n *   technicalBackgroundNeeded: boolean,\n *   modality: 'remote' | 'hybrid' | 'onsite',\n *   candidateId: string (ID del candidate logueado)\n * }\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n\n    // Validar el body\n    const validation = validateCreateJobRequest(body);\n    if (!validation.valid || !validation.data) {\n      return NextResponse.json(\n        { error: validation.error || 'Invalid request body' },\n        { status: 400 }\n      );\n    }\n\n    // Obtener candidateId del body (en el futuro esto vendrá de la autenticación)\n    const candidateId = body.candidateId;\n    if (!candidateId || typeof candidateId !== 'string') {\n      return NextResponse.json(\n        { error: 'candidateId is required in the request body' },\n        { status: 400 }\n      );\n    }\n\n    // Crear el job\n    const job = await createJobFromCandidate(candidateId, validation.data);\n\n    return NextResponse.json(\n      {\n        success: true,\n        job,\n        message: 'Job created successfully',\n      },\n      { status: 201 }\n    );\n  } catch (error: any) {\n    console.error('❌ Error creating job:', error);\n    \n    // Manejar errores específicos\n    if (error.message?.includes('not found')) {\n      return NextResponse.json(\n        { error: error.message },\n        { status: 404 }\n      );\n    }\n\n    if (error.message?.includes('current_company')) {\n      return NextResponse.json(\n        { error: error.message },\n        { status: 400 }\n      );\n    }\n\n    return NextResponse.json(\n      {\n        error: 'Error creating job',\n        details: process.env.NODE_ENV === 'development' ? error.message : undefined,\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}